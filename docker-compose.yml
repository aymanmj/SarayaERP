version: "3.8"

services:
  # 1. قاعدة البيانات (PostgreSQL)
  postgres:
    image: postgres:15-alpine
    container_name: saraya_db
    restart: always
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: strong_password_123
      POSTGRES_DB: saraya_erp
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - saraya_net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d saraya_erp"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 2. نظام الطوابير (Redis)
  redis:
    image: redis:alpine
    container_name: saraya_redis
    restart: always
    volumes:
      - redis_data:/data
    networks:
      - saraya_net

  # 3. السيرفر (Backend API)
  backend:
    build: ./server
    container_name: saraya_backend
    restart: always
    environment:
      # الاتصال بقاعدة البيانات داخل الشبكة
      DATABASE_URL: "postgresql://admin:strong_password_123@postgres:5432/saraya_erp?schema=public"

      # مفاتيح الأمان (يجب تغييرها في بيئة العميل الحقيقية)
      JWT_SECRET: "PRODUCTION_SECRET_KEY_CHANGE_ME"
      JWT_EXPIRES_IN: "86400s"

      # اتصال Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379

      # بيئة التشغيل
      NODE_ENV: production

      # مسار ملف الرخصة (سيتم تخزينه في مجلد دائم)
      LICENSE_PATH: "/app/data/saraya.lic"
    volumes:
      # مجلد لحفظ ملف الرخصة بشكل دائم حتى لا يضيع عند إعادة التشغيل
      - app_data:/app/data
    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - saraya_net

  # 4. الواجهة الأمامية (Frontend)
  frontend:
    build: ./client
    container_name: saraya_frontend
    restart: always
    ports:
      - "80:80" # الوصول المباشر عبر المنفذ 80
    depends_on:
      - backend
    networks:
      - saraya_net

# وحدات التخزين الدائمة
volumes:
  postgres_data:
  redis_data:
  app_data: # لحفظ ملف الرخصة

# الشبكة الداخلية المعزولة
networks:
  saraya_net:
    driver: bridge

backup:
  image: postgres:15-alpine
  container_name: saraya_backup
  depends_on:
    - postgres
  volumes:
    - ./backups:/backups # مجلد لحفظ النسخ على جهازك
    - ./backup.sh:/backup.sh # السكربت
  environment:
    POSTGRES_HOST: postgres
    POSTGRES_DB: saraya_erp
    POSTGRES_USER: admin
    POSTGRES_PASSWORD: admin_password
  entrypoint: |
    sh -c '
    echo "⏳ Backup service started..."
    chmod +x /backup.sh
    # إضافة مهمة Cron: كل يوم الساعة 2 صباحاً و 2 ظهراً
    echo "0 2,14 * * * /backup.sh >> /var/log/cron.log 2>&1" > /etc/crontabs/root
    crond -f -l 8
    '
