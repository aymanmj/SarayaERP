<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>{{#if (eq invoiceType 'CREDIT_NOTE')}}إشعار دائن{{else}}فاتورة ضريبية{{/if}} #{{invoiceId}}</title>
  
  <!-- Embedding CSS for absolute predictability in PDF generation -->
  <style>
    /* Cairo font included via @font-face for reliable loading in Puppeteer */
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap');

    :root {
      --primary: #0f766e; /* Elegant Emerald */
      --primary-light: #f0fdfa; /* Light Emerald */
      --secondary: #334155; /* Slate 700 */
      --text: #0f172a; /* Slate 900 */
      --text-muted: #64748b; /* Slate 500 */
      --border: #e2e8f0; /* Slate 200 */
      --background: #f8fafc; /* Slate 50 */
      
      --danger: #be123c; /* Rose 700 for Credit Notes */
      --danger-light: #fff1f2;
    }

    /* Global Typography & Body */
    body {
      font-family: 'Cairo', system-ui, -apple-system, sans-serif;
      font-size: 11px;
      color: var(--text);
      line-height: 1.5;
      margin: 0;
      padding: 0;
      -webkit-print-color-adjust: exact;
      background: white;
    }

    * { box-sizing: border-box; }

    /* Page Container for A4 padding */
    .page-container {
      width: 100%;
      padding: 40px;
      position: relative;
    }

    /* Watermark for Credit Notes */
    .watermark {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-30deg);
      font-size: 120px;
      font-weight: 900;
      color: rgba(190, 18, 60, 0.04);
      border: 8px solid rgba(190, 18, 60, 0.04);
      padding: 20px 80px;
      border-radius: 30px;
      z-index: 0;
      pointer-events: none;
      letter-spacing: 5px;
    }

    /* 1. HEADER SECTION */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 25px;
      border-bottom: 3px solid var(--primary);
      margin-bottom: 25px;
    }

    .brand-section {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .hospital-title {
      color: var(--primary);
      font-size: 26px;
      font-weight: 800;
      margin: 0;
      letter-spacing: -0.5px;
    }

    .hospital-contact {
      color: var(--text-muted);
      font-size: 10px;
      margin: 0;
    }

    .doc-meta {
      text-align: left;
    }

    .doc-title {
      font-size: 22px;
      font-weight: 800;
      color: var(--text);
      letter-spacing: 1px;
      margin-bottom: 5px;
    }

    .doc-badge {
      display: inline-block;
      background: var(--text);
      color: white;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 700;
      font-family: monospace;
      letter-spacing: 1px;
    }

    /* Override for Credit note */
    .theme-credit .header { border-bottom-color: var(--danger); }
    .theme-credit .doc-title { color: var(--danger); }
    .theme-credit .doc-badge { background: var(--danger); }
    .theme-credit .hospital-title { color: var(--danger); }

    /* 2. INFO CARDS SECTION */
    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .info-card {
      background-color: var(--background);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 18px;
    }

    .theme-credit .info-card {
      background-color: var(--danger-light);
      border-color: #fecdd3;
    }

    .info-card-title {
      font-size: 12px;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 12px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      padding-bottom: 6px;
    }
    
    .theme-credit .info-card-title { color: var(--danger); }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .info-row:last-child { margin-bottom: 0; }

    .info-label {
      color: var(--text-muted);
      font-weight: 600;
      font-size: 10px;
    }

    .info-value {
      color: var(--text);
      font-weight: 700;
      font-size: 11px;
    }

    /* 3. INVOICE ITEMS TABLE */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-bottom: 30px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    thead th {
      background-color: var(--primary);
      color: white;
      text-transform: uppercase;
      font-size: 10px;
      font-weight: 700;
      padding: 12px;
      text-align: right;
      letter-spacing: 0.5px;
    }

    .theme-credit thead th { background-color: var(--danger); }

    th.col-num, td.col-num { width: 5%; text-align: center; }
    th.col-desc, td.col-desc { width: 45%; }
    th.col-qty, td.col-qty { width: 10%; text-align: center; }
    th.col-price, td.col-price { width: 15%; text-align: right; }
    th.col-total, td.col-total { width: 15%; text-align: right; }

    tbody td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
      color: var(--text);
    }

    tbody tr:last-child td { border-bottom: none; }
    tbody tr:nth-child(even) td { background-color: #f8fafc; }

    td.col-desc { font-weight: 700; color: var(--secondary); }
    td.col-price, td.col-total { font-family: monospace; font-size: 12px; }
    td.col-total { font-weight: 800; color: var(--text); }

    /* 4. TOTALS AND NOTES SECTION */
    .summary-section {
      display: flex;
      justify-content: space-between;
      gap: 30px;
      margin-bottom: 50px;
    }

    .notes-box {
      flex: 1.5;
    }

    .notes-title {
      font-weight: 800;
      font-size: 12px;
      color: var(--secondary);
      margin-bottom: 8px;
    }

    .notes-list {
      margin: 0;
      padding: 0;
      list-style: none;
      color: var(--text-muted);
      font-size: 10px;
      line-height: 1.8;
    }

    .notes-list li::before {
      content: "•";
      color: var(--primary);
      font-weight: bold;
      display: inline-block;
      width: 1em;
    }
    .theme-credit .notes-list li::before { color: var(--danger); }

    .totals-box {
      flex: 1;
      background: white;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .total-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      font-size: 11px;
      color: var(--secondary);
    }

    .total-line.discount { color: var(--danger); }
    
    .total-line .amount {
      font-family: monospace;
      font-weight: 700;
      font-size: 12px;
    }

    .total-line.grand-total {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid var(--border);
      font-size: 16px;
      font-weight: 800;
      color: var(--primary);
    }
    .theme-credit .total-line.grand-total { color: var(--danger); }
    
    .total-line.grand-total .amount {
      font-size: 18px;
    }

    /* 5. FOOTER & SIGNATURES */
    .signatures-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-top: 40px;
      padding: 0 20px;
    }

    .signature-block {
      text-align: center;
      width: 160px;
    }

    .signature-line {
      border-bottom: 1.5px dashed var(--text-muted);
      height: 40px;
      margin-bottom: 8px;
    }

    .signature-title {
      font-weight: 700;
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
    }

    .qr-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .qr-image {
      width: 80px;
      height: 80px;
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 4px;
      margin-bottom: 5px;
    }

    .qr-text {
      font-size: 8px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

  </style>
</head>
<body class="{{#if (eq invoiceType 'CREDIT_NOTE')}}theme-credit{{/if}}">

  {{#if (eq invoiceType 'CREDIT_NOTE')}}
    <div class="watermark">إشعار دائن</div>
  {{/if}}

  <div class="page-container">
    
    <!-- 1. Header -->
    <div class="header">
      <div class="brand-section">
        <h1 class="hospital-title">{{hospitalName}}</h1>
        <p class="hospital-contact">{{address}}</p>
        <p class="hospital-contact" dir="ltr">{{phone}} | {{email}}</p>
      </div>

      <div class="doc-meta">
        <div class="doc-title">{{#if (eq invoiceType 'CREDIT_NOTE')}}تفاصيل المرتجع{{else}}فاتورة ضريبية{{/if}}</div>
        <div class="doc-badge">#{{invoiceId}}</div>
      </div>
    </div>

    <!-- 2. Info Cards -->
    <div class="info-grid">
      
      <!-- Patient Details -->
      <div class="info-card">
        <div class="info-card-title">بيانات المريض (Patient Details)</div>
        <div class="info-row">
          <span class="info-label">اسم المريض</span>
          <span class="info-value">{{patientName}}</span>
        </div>
        <div class="info-row">
          <span class="info-label">رقم الملف (MRN)</span>
          <span class="info-value" style="font-family: monospace;">{{mrn}}</span>
        </div>
        <div class="info-row">
          <span class="info-label">الجهة الضامنة</span>
          <span class="info-value">{{insuranceProvider}}</span>
        </div>
      </div>

      <!-- Invoice Details -->
      <div class="info-card">
        <div class="info-card-title">تفاصيل المستند (Document Info)</div>
        <div class="info-row">
          <span class="info-label">تاريخ الإصدار</span>
          <span class="info-value">{{formatDate invoiceDate}}</span>
        </div>
        <div class="info-row">
          <span class="info-label">الحالة التسديد</span>
          <span class="info-value">{{status}}</span>
        </div>
        {{#if originalInvoiceId}}
        <div class="info-row">
          <span class="info-label">الفاتورة الأصلية</span>
          <span class="info-value" style="font-family: monospace;">#{{originalInvoiceId}}</span>
        </div>
        {{/if}}
      </div>

    </div>

    <!-- 3. Billing Items Table -->
    <table>
      <thead>
        <tr>
          <th class="col-num">#</th>
          <th class="col-desc">البيان (Description)</th>
          <th class="col-qty">الكمية</th>
          <th class="col-price">السعر (LYD)</th>
          <th class="col-total">الإجمالي (LYD)</th>
        </tr>
      </thead>
      <tbody>
        {{#each items}}
          <tr>
            <td class="col-num">{{inc @index}}</td>
            <td class="col-desc">{{serviceName}}</td>
            <td class="col-qty">{{quantity}}</td>
            <td class="col-price">{{formatCurrency unitPrice ""}}</td>
            <td class="col-total">{{formatCurrency totalAmount ""}}</td>
          </tr>
        {{/each}}
      </tbody>
    </table>

    <!-- 4. Summary Section -->
    <div class="summary-section">
      
      <!-- Notes & Terms -->
      <div class="notes-box">
        <div class="notes-title">الشروط والأحكام (Terms & Conditions)</div>
        <ul class="notes-list">
          <li>تعتبر هذه الفاتورة سنداً رسمياً معتمداً من {{hospitalName}}.</li>
          <li>الرجاء مراجعة قسم الحسابات خلال 3 أيام في حال وجود أي خطأ.</li>
          <li>يحق للمريض استرجاع المبالغ حسب سياسة الاسترداد المعتمدة وفي مدة لا تتجاوز 14 يوماً.</li>
          <li>تم إنشاء هذا المستند إلكترونياً ولا يحتاج إلى ختم.</li>
        </ul>
      </div>

      <!-- Totals -->
      <div class="totals-box">
        <div class="total-line">
          <span>المجموع الفرعي (Subtotal)</span>
          <span class="amount">{{formatCurrency subTotal ""}}</span>
        </div>
        
        {{#if (gt discountAmount 0)}}
        <div class="total-line discount">
          <span>الخصم (Discount)</span>
          <span class="amount">-{{formatCurrency discountAmount ""}}</span>
        </div>
        {{/if}}

        {{#if (gt vatAmount 0)}}
        <div class="total-line">
          <span>الضريبة (VAT)</span>
          <span class="amount">{{formatCurrency vatAmount ""}}</span>
        </div>
        {{/if}}

        <div class="total-line grand-total">
          <span>الإجمالي الكلي (Net Total)</span>
          <span class="amount">LYD {{formatCurrency netAmount ""}}</span>
        </div>
      </div>

    </div>

    <!-- 5. Footer & Signatures -->
    <div class="signatures-row">
      <div class="signature-block">
        <div class="signature-line"></div>
        <div class="signature-title">المحاسب (Cashier)</div>
      </div>
      
      <div class="qr-container">
        {{#if qrCode}}
          <img src="{{qrCode}}" class="qr-image" alt="QR Code" />
          <span class="qr-text">مسح للتحقق</span>
        {{else}}
           <div style="height: 90px;"></div>
        {{/if}}
      </div>

      <div class="signature-block">
        <div class="signature-line"></div>
        <div class="signature-title">المستلم (Receiver)</div>
      </div>
    </div>

  </div> <!-- End Page Container -->
</body>
</html>


{{!-- <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>{{#if (eq invoiceType 'CREDIT_NOTE')}}إشعار دائن{{else}}فاتورة ضريبية{{/if}} #{{invoiceId}}</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0f766e; /* Emerald 700 */
            --primary-light: #f0fdfa;
            --danger: #be123c; /* Rose 700 */
            --danger-light: #fff1f2;
            --text-dark: #1e293b;
            --text-gray: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Cairo', sans-serif;
            font-size: 12px;
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            -webkit-print-color-adjust: exact;
        }

        .page-container {
            width: 100%;
            max-width: 210mm; /* A4 width */
            margin: 0 auto;
            padding: 40px;
            box-sizing: border-box;
            background: white;
            position: relative;
        }

        /* Watermark for Credit Note */
        .watermark {
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 100px;
            font-weight: 900;
            color: rgba(190, 18, 60, 0.08);
            border: 8px solid rgba(190, 18, 60, 0.08);
            padding: 20px 60px;
            border-radius: 20px;
            z-index: 0;
            pointer-events: none;
            white-space: nowrap;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .hospital-details h1 {
            color: var(--primary);
            font-size: 24px;
            margin: 0 0 5px 0;
        }
        .hospital-details p {
            margin: 2px 0;
            font-size: 11px;
            color: var(--text-gray);
        }

        .invoice-meta {
            text-align: left;
        }
        .doc-title {
            font-size: 22px;
            font-weight: 800;
            text-transform: uppercase;
            color: var(--text-dark);
            letter-spacing: 1px;
        }
        .doc-subtitle {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 8px;
        }
        .invoice-id {
            background: var(--text-dark);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            display: inline-block;
        }

        /* Info Grid */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .info-box {
            background: var(--primary-light);
            border: 1px solid #ccfbf1;
            border-radius: 8px;
            padding: 15px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            border-bottom: 1px dashed #e2e8f0;
            padding-bottom: 4px;
        }
        .info-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .info-label {
            font-weight: 600;
            color: var(--text-gray);
            font-size: 11px;
        }
        .info-val {
            font-weight: 700;
            color: var(--text-dark);
        }

        /* Special style for Credit Note Header */
        .is-credit-note .doc-title { color: var(--danger); }
        .is-credit-note .invoice-id { background: var(--danger); }
        .is-credit-note .info-box { background: var(--danger-light); border-color: #fecdd3; }

        /* Items Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            font-size: 12px;
        }
        th {
            background-color: var(--text-dark);
            color: white;
            padding: 12px;
            text-align: right;
            font-weight: 600;
        }
        .is-credit-note th { background-color: var(--danger); }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            vertical-align: top;
        }
        tr:nth-child(even) td { background-color: #f8fafc; }
        
        .col-num { width: 40px; text-align: center; color: var(--text-gray); }
        .col-desc { font-weight: 600; }
        .col-qty { text-align: center; width: 60px; }
        .col-price { text-align: right; width: 100px; font-family: monospace; }
        .col-total { text-align: right; width: 120px; font-weight: 700; font-family: monospace; }

        /* Footer Section */
        .footer-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 40px;
            margin-top: 20px;
        }
        
        .terms-box {
            font-size: 10px;
            color: var(--text-gray);
            line-height: 1.6;
        }
        .qr-box {
            margin-top: 15px;
            width: 80px;
            height: 80px;
            border: 1px solid var(--border);
            padding: 4px;
        }
        .qr-img { width: 100%; height: 100%; }

        .totals-box {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
        }
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .total-row.grand {
            border-top: 2px solid var(--text-dark);
            padding-top: 10px;
            margin-top: 10px;
            font-size: 16px;
            font-weight: 800;
            color: var(--primary);
        }
        .is-credit-note .total-row.grand { color: var(--danger); border-top-color: var(--danger); }

        .signatures {
            margin-top: 60px;
            display: flex;
            justify-content: space-between;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            font-size: 11px;
            color: var(--text-gray);
        }
    </style>
</head>
<body class="{{#if (eq invoiceType 'CREDIT_NOTE')}}is-credit-note{{/if}}">

    {{#if (eq invoiceType 'CREDIT_NOTE')}}
      <div class="watermark">مرتجع / RETURN</div>
    {{/if}}

    <div class="page-container">
        <!-- Header -->
        {{#if printHeaderFooter}}
        <div class="header">
            <div class="hospital-details">
                <h1>{{hospitalName}}</h1>
                <p>{{address}}</p>
                <p style="direction: ltr; text-align: right;">{{phone}} | {{email}}</p>
            </div>
            <div class="invoice-meta">
                {{#if (eq invoiceType 'CREDIT_NOTE')}}
                  <div class="doc-title">إشعار دائن</div>
                  <div class="doc-subtitle">Credit Note</div>
                {{else}}
                  <div class="doc-title">فاتورة ضريبية</div>
                  <div class="doc-subtitle">Tax Invoice</div>
                {{/if}}
                <div class="invoice-id">#{{invoiceId}}</div>
            </div>
        </div>
        {{else}}
        <div style="height: 140px;"></div> <!-- Spacer for pre-printed paper -->
        <div style="text-align: left; margin-bottom: 20px;">
            <div class="invoice-id">#{{invoiceId}}</div>
        </div>
        {{/if}}

        <!-- Info Grid -->
        <div class="info-grid">
            <div class="info-box">
                <div class="info-row">
                    <span class="info-label">المريض / Patient</span>
                    <span class="info-val">{{patientName}}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">رقم الملف / MRN</span>
                    <span class="info-val" style="font-family: monospace;">{{mrn}}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">الجهة الضامنة / Client</span>
                    <span class="info-val">{{insuranceProvider}}</span>
                </div>
            </div>
            <div class="info-box">
                <div class="info-row">
                    <span class="info-label">تاريخ الإصدار / Date</span>
                    <span class="info-val">{{formatDate invoiceDate}}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">حالة الفاتورة / Status</span>
                    <span class="info-val">{{status}}</span>
                </div>
                {{#if originalInvoiceId}}
                <div class="info-row">
                    <span class="info-label">رقم الفاتورة الأصلية</span>
                    <span class="info-val">#{{originalInvoiceId}}</span>
                </div>
                {{/if}}
            </div>
        </div>

        <!-- Items Table -->
        <table>
            <thead>
                <tr>
                    <th class="col-num">#</th>
                    <th>البيان / Description</th>
                    <th class="col-qty">الكمية</th>
                    <th class="col-price">السعر</th>
                    <th class="col-total">الإجمالي</th>
                </tr>
            </thead>
            <tbody>
                {{#each items}}
                <tr>
                    <td class="col-num">{{inc @index}}</td>
                    <td class="col-desc">{{serviceName}}</td>
                    <td class="col-qty">{{quantity}}</td>
                    <td class="col-price">{{formatMoney unitPrice}}</td>
                    <td class="col-total">{{formatMoney totalAmount}}</td>
                </tr>
                {{/each}}
            </tbody>
        </table>

        <!-- Footer Grid -->
        <div class="footer-grid">
            <div class="terms-box">
                <strong>الشروط والأحكام:</strong><br>
                1. تعتبر هذه الفاتورة سند استحقاق رسمي.<br>
                2. في حال وجود خطأ، يرجى المراجعة خلال 3 أيام.<br>
                3. هذه الفاتورة صادرة إلكترونياً من نظام Saraya ERP.<br>
                
                {{#if qrCode}}
                <div class="qr-box">
                    <img src="{{qrCode}}" class="qr-img"/>
                </div>
                {{/if}}
            </div>

            <div class="totals-box">
                <div class="total-row">
                    <span>المجموع الفرعي</span>
                    <span>{{formatMoney subTotal}}</span>
                </div>
                {{#if (gt discountAmount 0)}}
                <div class="total-row" style="color: var(--danger);">
                    <span>الخصم</span>
                    <span>({{formatMoney discountAmount}})</span>
                </div>
                {{/if}}
                {{#if (gt vatAmount 0)}}
                <div class="total-row">
                    <span>الضريبة (VAT)</span>
                    <span>{{formatMoney vatAmount}}</span>
                </div>
                {{/if}}
                <div class="total-row grand">
                    <span>الإجمالي المستحق</span>
                    <span>{{formatMoney netAmount}} <small style="font-size:10px; font-weight:400;">LYD</small></span>
                </div>
            </div>
        </div>

        <div class="signatures">
            <div>المحاسب / Cashier</div>
            <div>المستلم / Receiver</div>
            <div>المدير المالي / Financial Manager</div>
        </div>
        
        <div style="text-align:center; margin-top:20px; font-size:9px; color:#cbd5e1;">
            Powered by Saraya ERP Systems
        </div>
    </div>
</body>
</html>
 --}}



{{!-- <html lang='ar' dir='rtl'>
  <head>
    <meta charset='UTF-8' />
    <title>{{#if (eq invoiceType 'CREDIT_NOTE')}}إشعار دائن{{else}}فاتورة ضريبية{{/if}} #{{invoiceId}}</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Cairo', 'Segoe UI', Tahoma, sans-serif;
        font-size: 10px;
        color: #334155; /* Slate-700 */
        line-height: 1.5;
        margin: 0;
        padding: 0;
      }

      .container {
        width: 100%;
        margin: 0 auto;
      }

      /* Header Styling */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center; /* Center Vertically */
        border-bottom: 2px solid #0f766e; /* Emerald-700 */
        padding-bottom: 25px;
        margin-bottom: 30px;
      }

      .hospital-info h1 {
        color: #0f766e;
        font-size: 22px;
        margin: 0 0 5px 0;
        font-weight: 700;
      }

      .hospital-info p {
        margin: 2px 0;
        font-size: 10px;
        color: #64748b;
      }

      .invoice-info {
        text-align: left;
      }

      .doc-title {
        font-size: 18px;
        font-weight: 700;
        text-transform: uppercase;
        color: #1e293b;
        margin-bottom: 5px;
      }
      
      .doc-title.credit-note {
        color: #be123c; /* Rose-700 */
      }

      .invoice-number-badge {
        background: #f1f5f9;
        padding: 5px 10px;
        border-radius: 4px;
        font-family: 'Courier New', Courier, monospace;
        font-weight: bold;
        font-size: 14px;
        color: #334155;
        border: 1px solid #e2e8f0;
        display: inline-block;
      }

      /* Meta Grid */
      .meta-box {
        display: flex;
        flex-wrap: wrap;
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 25px;
      }

      .meta-item {
        width: 25%; /* 4 columns */
        margin-bottom: 5px;
      }

      .meta-label {
        font-size: 9px;
        color: #94a3b8;
        font-weight: 600;
        display: block;
        margin-bottom: 2px;
      }

      .meta-value {
        font-size: 11px;
        font-weight: 700;
        color: #0f172a;
      }

      /* Table */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 30px;
      }

      th {
        background-color: #0f766e;
        color: white;
        padding: 10px;
        text-align: right;
        font-size: 10px;
        font-weight: 600;
      }

      td {
        padding: 10px;
        border-bottom: 1px solid #e2e8f0;
        font-size: 10px;
        vertical-align: middle;
      }

      tr:nth-child(even) {
        background-color: #f8fafc;
      }
      
      .row-num {
        color: #94a3b8;
        font-family: monospace;
      }

      /* Footer Section */
      .footer-section {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-top: 10px;
        page-break-inside: avoid;
      }

      .notes-box {
        width: 55%;
        font-size: 9px;
        color: #64748b;
        padding: 12px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        line-height: 1.6;
      }

      .totals-box {
        width: 35%;
      }

      .total-row {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        font-size: 11px;
      }

      .total-row.final {
        border-top: 2px solid #0f172a;
        background: #f1f5f9;
        padding: 10px;
        margin-top: 10px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 800;
        color: #0f766e;
      }
      
      .total-row.final.credit {
        color: #be123c;
      }

      /* Watermark */
      .watermark {
        position: fixed;
        top: 40%;
        left: 25%;
        transform: rotate(-30deg);
        font-size: 80px;
        color: rgba(190, 18, 60, 0.05);
        font-weight: 800;
        z-index: -1;
        border: 8px solid rgba(190, 18, 60, 0.05);
        padding: 40px;
        border-radius: 20px;
      }

      .qr-code {
        margin-top: 20px;
        text-align: left; /* Align with headers if needed, or keeping styling minimal */
      }
      .qr-img {
        width: 80px;
        height: 80px;
        border: 1px solid #eee;
        padding: 4px;
        background: white;
      }
      
      .system-footer {
        text-align: center;
        margin-top: 40px;
        padding-top: 10px;
        border-top: 1px solid #e2e8f0;
        font-size: 8px;
        color: #cbd5e1;
      }
    </style>
  </head>
  <body>

    {{#if (eq invoiceType 'CREDIT_NOTE')}}
      <div class="watermark">مرتجع / RETURN</div>
    {{/if}}

    {{#if printHeaderFooter}}
    <!-- Header -->
    <div class='header'>
      <div class="hospital-info">
        <h1 class='hospital-name'>{{hospitalName}}</h1>
        <p>{{address}}</p>
        <p dir="ltr">{{phone}} | {{email}}</p>
      </div>
      <div class="invoice-info">
        {{#if (eq invoiceType 'CREDIT_NOTE')}}
          <div class='doc-title credit-note'>إشعار دائن <span style="font-size:12px; color:#94a3b8; font-weight:400;">(Credit Note)</span></div>
        {{else}}
          <div class='doc-title'>فاتورة ضريبية <span style="font-size:12px; color:#94a3b8; font-weight:400;">(Tax Invoice)</span></div>
        {{/if}}
        <div class='invoice-number-badge'>#{{invoiceId}}</div>
      </div>
    </div>
    {{else}}
    <!-- Spacer for pre-printed paper -->
    <div style="height: 150px;"></div>
    <div class="invoice-info" style="text-align: left; margin-bottom: 20px;">
        <div class='invoice-number-badge'>#{{invoiceId}}</div>
    </div>
    {{/if}}

    <!-- Meta Grid -->
    <div class='meta-box'>
      <div class='meta-item'>
        <span class='meta-label'>المريض (Patient)</span>
        <span class='meta-value'>{{patientName}}</span>
        <div style="font-size: 9px; color: #64748b; margin-top:1px;">MRN: {{mrn}}</div>
      </div>
      
      <div class='meta-item'>
        <span class='meta-label'>التاريخ (Date)</span>
        <span class='meta-value'>{{formatDate invoiceDate}}</span>
      </div>

      <div class='meta-item'>
        <span class='meta-label'>العميل/الضامن (Client)</span>
        <span class='meta-value'>{{insuranceProvider}}</span>
      </div>

      <div class='meta-item'>
        <span class='meta-label'>الحالة (Status)</span>
        <span class='meta-value' style="{{#if (eq status 'PAID')}}color:#15803d;{{else}}color:#b45309;{{/if}}">
          {{status}}
        </span>
      </div>
    </div>

    <!-- Items Table -->
    <table>
      <thead>
        <tr>
          <th width='5%'>#</th>
          <th width='50%'>الخدمة (Description)</th>
          <th width='10%' style="text-align: center;">الكمية</th>
          <th width='15%'>سعر الوحدة</th>
          <th width='20%'>الإجمالي</th>
        </tr>
      </thead>
      <tbody>
        {{#each items}}
          <tr>
            <td class="row-num">{{inc @index}}</td>
            <td>
              <div style='font-weight: 700;'>{{serviceName}}</div>
            </td>
            <td style="text-align: center;">{{quantity}}</td>
            <td>{{formatMoney unitPrice}}</td>
            <td>{{formatMoney totalAmount}}</td>
          </tr>
        {{/each}}
      </tbody>
    </table>

    <!-- Footer & Totals -->
    <div class='footer-section'>
      <div class="notes-box">
        <strong>ملاحظات / Notes:</strong><br>
        تم إصدار هذه الفاتورة إلكترونياً ولا تحتاج إلى توقيع.<br>
        يرجى الاحتفاظ بهذا المستند للمراجعة.
        {{#if (eq invoiceType 'CREDIT_NOTE')}}
        <br><span style="color: #be123c;">* هذا المستند يمثل استرداداً للمبلغ.</span>
        {{/if}}
        
        <div class='qr-code'>
          {{#if qrCode}}
            <img src='{{qrCode}}' class='qr-img' />
          {{/if}}
        </div>
      </div>

      <div class='totals-box'>
        <div class='total-row'>
          <span>المجموع (Subtotal)</span>
          <span>{{formatMoney subTotal}}</span>
        </div>
        
        {{#if (gt discountAmount 0)}}
        <div class='total-row' style="color: #be123c;">
          <span>الخصم (Discount)</span>
          <span>- {{formatMoney discountAmount}}</span>
        </div>
        {{/if}}

        {{#if (gt vatAmount 0)}}
        <div class='total-row'>
          <span>الضريبة (VAT)</span>
          <span>{{formatMoney vatAmount}}</span>
        </div>
        {{/if}}

        <div class="total-row {{#if (eq invoiceType 'CREDIT_NOTE')}}final credit{{else}}final{{/if}}">
          <span>الإجمالي (Total)</span>
          <span><span style="font-size:10px; font-weight:normal;">LYD</span> {{formatMoney netAmount}}</span>
        </div>
      </div>
    </div>
    
    <div class="system-footer">
       Saraya ERP Systems &copy; 2026
    </div>

  </body>
</html> --}}