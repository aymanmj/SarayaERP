<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>{{#if (eq invoiceType 'CREDIT_NOTE')}}إشعار دائن{{else}}فاتورة ضريبية{{/if}} #{{invoiceId}}</title>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap');

    :root {
      --primary: #0f766e; /* Elegant Emerald */
      --primary-light: #f0fdfa; /* Light Emerald */
      --secondary: #334155; /* Slate 700 */
      --text: #0f172a; /* Slate 900 */
      --text-muted: #64748b; /* Slate 500 */
      --border: #e2e8f0; /* Slate 200 */
      --background: #f8fafc; /* Slate 50 */
      
      --danger: #be123c; /* Rose 700 for Credit Notes */
      --danger-light: #fff1f2;
    }

    /* Global Typography & Body */
    body {
      font-family: 'Cairo', system-ui, -apple-system, sans-serif;
      font-size: 11px;
      color: var(--text);
      line-height: 1.5;
      margin: 0;
      padding: 0;
      -webkit-print-color-adjust: exact;
      background: white;
    }

    * { box-sizing: border-box; }

    /* Page Container for A4 padding */
    .page-container {
      width: 100%;
      padding: 40px;
      position: relative;
    }

    /* Watermark for Credit Notes */
    .watermark {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-30deg);
      font-size: 120px;
      font-weight: 900;
      color: rgba(190, 18, 60, 0.04);
      border: 8px solid rgba(190, 18, 60, 0.04);
      padding: 20px 80px;
      border-radius: 30px;
      z-index: 0;
      pointer-events: none;
      letter-spacing: 5px;
    }

    /* 1. HEADER SECTION */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 25px;
      border-bottom: 3px solid var(--primary);
      margin-bottom: 25px;
    }

    .brand-section {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .hospital-title {
      color: var(--primary);
      font-size: 26px;
      font-weight: 800;
      margin: 0;
      letter-spacing: -0.5px;
    }

    .hospital-contact {
      color: var(--text-muted);
      font-size: 10px;
      margin: 0;
    }

    .doc-meta {
      text-align: left;
    }

    .doc-title {
      font-size: 22px;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 5px;
    }

    .doc-badge {
      display: inline-block;
      background: var(--text);
      color: white;
      padding: 4px 14px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 700;
      font-family: monospace;
      letter-spacing: 1px;
    }

    /* Override for Credit note */
    .theme-credit .header { border-bottom-color: var(--danger); }
    .theme-credit .doc-title { color: var(--danger); }
    .theme-credit .doc-badge { background: var(--danger); }
    .theme-credit .hospital-title { color: var(--danger); }

    /* 2. INFO CARDS SECTION */
    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .info-card {
      background-color: var(--background);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 18px;
    }

    .theme-credit .info-card {
      background-color: var(--danger-light);
      border-color: #fecdd3;
    }

    .info-card-title {
      font-size: 11px;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 12px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      padding-bottom: 6px;
      display: flex;
      align-items: center;
    }
    
    .en-text {
      direction: ltr; /* Fix RTL parenthesis rendering */
      unicode-bidi: embed;
      margin-right: 4px;
      font-weight: 600;
    }
    
    .theme-credit .info-card-title { color: var(--danger); }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .info-row:last-child { margin-bottom: 0; }

    .info-label {
      color: var(--text-muted);
      font-weight: 600;
      font-size: 10px;
    }

    .info-value {
      color: var(--text);
      font-weight: 700;
      font-size: 11px;
      text-align: left; /* Ensure it stays clean */
    }

    /* 3. INVOICE ITEMS TABLE */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-bottom: 30px;
      border-radius: 6px; /* Matched from screenshot */
      overflow: hidden;
      border: 1px solid var(--border);
    }

    thead th {
      background-color: var(--primary);
      color: white;
      text-transform: uppercase;
      font-size: 10px;
      font-weight: 700;
      padding: 10px 12px;
      text-align: right;
      letter-spacing: 0.5px;
    }

    .theme-credit thead th { background-color: var(--danger); }

    /* Fix alignments as per screenshot */
    th.col-num, td.col-num { width: 5%; text-align: center; }
    th.col-desc, td.col-desc { width: 45%; text-align: right; }
    th.col-qty, td.col-qty { width: 10%; text-align: center; }
    th.col-price, td.col-price { width: 20%; text-align: left; }
    th.col-total, td.col-total { width: 20%; text-align: left; }

    tbody td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
      color: var(--text);
    }

    tbody tr:last-child td { border-bottom: none; }
    tbody tr:nth-child(even) td { background-color: #f8fafc; }

    td.col-desc { font-weight: 700; color: var(--secondary); }
    td.col-price, td.col-total { font-family: monospace; font-size: 11px; }
    td.col-total { font-weight: 800; color: var(--text); }

    /* 4. TOTALS AND NOTES SECTION */
    .summary-section {
      display: flex;
      justify-content: space-between;
      gap: 30px;
      margin-bottom: 50px;
    }

    .notes-box {
      flex: 1.5;
    }

    .notes-title {
      font-weight: 800;
      font-size: 12px;
      color: var(--secondary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
    }

    .notes-list {
      margin: 0;
      padding: 0;
      list-style: none;
      color: var(--text-muted);
      font-size: 10px;
      line-height: 1.8;
    }

    .notes-list li::before {
      content: "•";
      color: var(--primary);
      font-weight: bold;
      display: inline-block;
      width: 1em;
    }
    .theme-credit .notes-list li::before { color: var(--danger); }

    .totals-box {
      flex: 1;
      background: white;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 20px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); /* Soft drop shadow matches screenshot */
    }

    .total-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      font-size: 11px;
      color: var(--secondary);
      align-items: center; /* Better vertical alignment */
    }

    .total-line.discount { color: var(--danger); }
    
    .total-line .amount {
      font-family: monospace;
      font-weight: 700;
      font-size: 12px;
    }

    .total-line.grand-total {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid var(--border);
      font-size: 14px;
      font-weight: 800;
      color: var(--primary);
    }
    .theme-credit .total-line.grand-total { color: var(--danger); }
    
    .total-line.grand-total .amount {
      font-size: 16px;
    }

    /* 5. FOOTER & SIGNATURES */
    .signatures-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-top: 40px;
      padding: 0 20px;
    }

    .signature-block {
      text-align: center;
      width: 160px;
    }

    .signature-line {
      border-bottom: 1.5px dashed var(--text-muted);
      height: 40px;
      margin-bottom: 8px;
    }

    .signature-title {
      font-weight: 700;
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
    }

    .qr-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .qr-image {
      width: 80px;
      height: 80px;
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 4px;
      margin-bottom: 0px;
    }

    .qr-text {
      font-size: 8px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

  </style>
</head>
<body class="{{#if (eq invoiceType 'CREDIT_NOTE')}}theme-credit{{/if}}">

  {{#if (eq invoiceType 'CREDIT_NOTE')}}
    <div class="watermark">إشعار دائن</div>
  {{/if}}

  <div class="page-container">
    
    <!-- 1. Header -->
    <div class="header">
      <div class="brand-section">
        <h1 class="hospital-title">{{hospitalName}}</h1>
        <p class="hospital-contact">{{address}}</p>
        <p class="hospital-contact" dir="ltr" style="text-align: right;">{{phone}} | {{email}}</p>
      </div>

      <div class="doc-meta">
        <div class="doc-title">{{#if (eq invoiceType 'CREDIT_NOTE')}}تفاصيل المرتجع{{else}}فاتورة ضريبية{{/if}}</div>
        <div class="doc-badge">#{{invoiceId}}</div>
      </div>
    </div>

    <!-- 2. Info Cards -->
    <div class="info-grid">
      
      <!-- Document Details -->
      <div class="info-card">
        <div class="info-card-title">تفاصيل المستند <span class="en-text">(Document Info)</span></div>
        <div class="info-row">
          <span class="info-label">تاريخ الإصدار</span>
          <span class="info-value" style="direction: ltr;">{{formatDate invoiceDate}}</span>
        </div>
        <div class="info-row">
          <span class="info-label">حالة التسديد</span>
          <span class="info-value">{{status}}</span>
        </div>
        {{#if originalInvoiceId}}
        <div class="info-row">
          <span class="info-label">الفاتورة الأصلية</span>
          <span class="info-value" style="font-family: monospace;">#{{originalInvoiceId}}</span>
        </div>
        {{/if}}
      </div>

      <!-- Patient Details -->
      <div class="info-card">
        <div class="info-card-title">بيانات المريض <span class="en-text">(Patient Details)</span></div>
        <div class="info-row">
          <span class="info-label">اسم المريض</span>
          <span class="info-value">{{patientName}}</span>
        </div>
        <div class="info-row">
          <span class="info-label">رقم الملف <span class="en-text" style="font-size: 9px; font-weight:600;">(MRN)</span></span>
          <span class="info-value" style="font-family: monospace;">{{mrn}}</span>
        </div>
        <div class="info-row">
          <span class="info-label">الجهة الضامنة</span>
          <span class="info-value">{{insuranceProvider}}</span>
        </div>
      </div>

    </div>

    <!-- 3. Billing Items Table -->
    <table>
      <thead>
        <tr>
          <th class="col-num">#</th>
          <th class="col-desc">البيان <span class="en-text" style="font-size: 9px; font-weight:700;">(Description)</span></th>
          <th class="col-qty">الكمية</th>
          <th class="col-price">السعر <span class="en-text" style="font-size: 8px; font-weight:700;">(LYD)</span></th>
          <th class="col-total">الإجمالي <span class="en-text" style="font-size: 8px; font-weight:700;">(LYD)</span></th>
        </tr>
      </thead>
      <tbody>
        {{#each items}}
          <tr>
            <td class="col-num">{{inc @index}}</td>
            <td class="col-desc">{{serviceName}}</td>
            <td class="col-qty" style="font-family: monospace;">{{quantity}}</td>
            <td class="col-price">{{formatCurrency unitPrice ""}}</td>
            <td class="col-total">{{formatCurrency totalAmount ""}}</td>
          </tr>
        {{/each}}
      </tbody>
    </table>

    <!-- 4. Summary Section -->
    <div class="summary-section">
      
      <!-- Notes & Terms -->
      <div class="notes-box">
        <div class="notes-title">الشروط والأحكام <span class="en-text" style="font-size: 10px; font-weight:700;">(Terms & Conditions)</span></div>
        <ul class="notes-list">
          <li>تعتبر هذه الفاتورة سنداً رسمياً معتمداً من {{hospitalName}}.</li>
          <li>الرجاء مراجعة قسم الحسابات خلال 3 أيام في حال وجود أي خطأ.</li>
          <li>يحق للمريض استرجاع المبالغ حسب سياسة الاسترداد المعتمدة وفي مدة لا تتجاوز 14 يوماً.</li>
          <li>تم إنشاء هذا المستند إلكترونياً ولا يحتاج إلى ختم.</li>
        </ul>
      </div>

      <!-- Totals -->
      <div class="totals-box">
        <div class="total-line">
          <span>المجموع الفرعي <span class="en-text" style="font-size: 9px;">(Subtotal)</span></span>
          <span class="amount">{{formatCurrency subTotal ""}}</span>
        </div>
        
        {{#if (gt discountAmount 0)}}
        <div class="total-line discount">
          <span>الخصم <span class="en-text" style="font-size: 9px;">(Discount)</span></span>
          <span class="amount">-{{formatCurrency discountAmount ""}}</span>
        </div>
        {{/if}}

        {{#if (gt vatAmount 0)}}
        <div class="total-line">
          <span>الضريبة <span class="en-text" style="font-size: 9px;">(VAT)</span></span>
          <span class="amount">{{formatCurrency vatAmount ""}}</span>
        </div>
        {{/if}}

        <div class="total-line grand-total">
          <span>الإجمالي الكلي <br/><span class="en-text" style="font-size: 12px;">(Net Total LYD)</span></span>
          <span class="amount">{{formatCurrency netAmount ""}}</span>
        </div>
      </div>

    </div>

    <!-- 5. Footer & Signatures -->
    <div class="signatures-row">
      
      <div class="signature-block" style="flex: 1; display:flex; justify-content:flex-start;">
          <!-- Empty spacer -->
      </div>
      
      <div class="qr-container" style="flex: 1;">
        {{#if qrCode}}
          <img src="{{qrCode}}" class="qr-image" alt="QR Code" />
        {{else}}
           <div style="height: 90px;"></div>
        {{/if}}
      </div>

      <div class="signature-block" style="flex: 1; display:flex; justify-content:flex-end;">
         <!-- Empty spacer for future signatures if needed -->
      </div>
      
    </div>

  </div> <!-- End Page Container -->